#!/usr/bin/ruby

require 'rubygems'
require 'puppetdb/connection'
require 'optparse'

# Take a list of facts and return it as a hash of hashes
def facthash(factlist)
  facts = {}
  factlist.each do |fact|
    if facts.include? fact['certname'] then
      facts[fact['certname']][fact['name']] = fact['value']
    else
      facts[fact['certname']] = {[fact['name']] => fact['value']}
    end
  end
  facts
end

options = {:puppetdb_host => "puppetdb",
           :puppetdb_port => 443,
           :query => nil}

opt = OptionParser.new

opt.on("--puppetdb [PUPPETDB]", "-p", "Host running PuppetDB (#{options[:puppetdb_host]})") do |v|
  options[:puppetdb_host] = v
end

opt.on("--port [PORT]", "-P", Integer, "Port PuppetDB is running on (#{options[:puppetdb_port]})") do |v|
  options[:puppetdb_port] = v
end

opt.on("--query [QUERY]", "-q", "Query String") do |v|
  options[:query] = v
end

opt.parse!

options[:query] ||= ARGV[0]

abort "Please specify a query" unless options[:query]

puppetdb = PuppetDB::Connection.new(options[:puppetdb_host], options[:puppetdb_port])
query = puppetdb.parse_query(options[:query])
results = puppetdb.query(:nodes, query)
results.each do |host|
  print host['name'] + "\n"
end
